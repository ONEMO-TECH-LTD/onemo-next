# 11.8 CSS Token Pipeline

> How tokens flow from Figma through CSS custom properties to Tailwind v4 utilities and Shopify Liquid templates.

**Status:** Normative (folder 11 — grows during execution, Dan approves)
**Linear issue:** ONE-177
**Depends on:** ONE-178 (naming convention — 11.5), ONE-181 (token scope)
**Companion docs:** 11.5 (naming rules), 11.6 (variable analysis), 11.7 (cleaned JSON baseline)

---

## 1. Pipeline Overview

```
┌──────────────────────┐
│  Figma (source of    │
│  truth for design)   │
└──────────┬───────────┘
           │  Manual export via Variables plugin
           v
┌──────────────────────────────────────────────┐
│  onemo-ssot-global/11-design-system/          │
│  11.7-figma-variables-baseline-feb16.json    │
│  886 vars, 8 collections (committed to SSOT) │
└──────────┬───────────────────────────────────┘
           │  node scripts/build-tokens.mjs
           v
     ┌─────┴─────┐
     │           │
     v           v
┌─────────┐  ┌──────────────┐
│ Next.js │  │ Shopify      │
│ Path    │  │ Theme Path   │
└────┬────┘  └──────┬───────┘
     │              │
     v              v
┌──────────────────────────────────────┐
│  src/app/tokens/                     │
│  ├── primitives.css     (L1 :root)  │
│  ├── aliases.css        (L2 :root)  │
│  ├── semantic.css       (L3 @theme) │
│  └── semantic-inline.css            │
│       (L3 :root + dark + @theme     │
│        inline)                       │
└──────────────────────────────────────┘
             +
┌──────────────────────────────────────┐
│  onemo-theme/                        │
│  ├── snippets/css-variables.liquid   │
│  │   (Liquid outputs CSS vars from   │
│  │    theme settings)                │
│  └── config/settings_schema.json     │
│      (color, font_picker, range      │
│       settings for Shopify admin)    │
└──────────────────────────────────────┘
```

### How tokens reach components

**Next.js path:**
```
Figma JSON → build-tokens.mjs → CSS files → @import in globals.css
  → Tailwind v4 reads @theme → generates utility classes
  → Components use: class="bg-bg-primary text-text-primary p-xl"
```

**Shopify theme path:**
```
Figma JSON → build-tokens.mjs → settings_schema.json + css-variables.liquid
  → Theme editor exposes settings (color pickers, font pickers)
  → Liquid renders CSS custom properties from settings values
  → Theme CSS uses: var(--color-bg-primary)
```

---

## 2. Source JSON Structure

The Figma Variables plugin exports a JSON array of 8 collection objects. Each collection has this shape:

```json
[
  {
    "_Alias": {                          // Collection name (key)
      "modes": {
        "Style": {                       // Mode name
          "Typography": {                // Group hierarchy
            "Font-Family": {
              "Primary": {               // Variable name (leaf)
                "$scopes": ["ALL_SCOPES"],
                "$type": "string",       // "string", "float", or "color"
                "$libraryName": "",
                "$collectionName": "_Primitives",  // Cross-collection ref target
                "$value": "{Typography.Font Family.Basic.Satoshi}"  // Reference
              }
            }
          }
        }
      }
    }
  }
]
```

### Key patterns

**Literal value:** `$value` contains the final value directly.
```json
{ "$value": "#ffffff", "$type": "color" }
{ "$value": 72, "$type": "float" }
{ "$value": "Satoshi", "$type": "string" }
```

**Cross-collection reference:** `$value` starts with `{`, and `$collectionName` tells which collection to look in.
```json
{
  "$value": "{Typography.Type Scale.72}",
  "$collectionName": "_Primitives"
}
```
The path inside `{}` uses dot-separated segments matching the JSON key hierarchy.

**Self-reference (within same collection):** `$value` starts with `{` but `$collectionName` matches the current collection (or is absent). Common in `1. Color modes` where dark mode tokens reference other tokens in the same collection.
```json
{
  "$value": "{Colors.Background.bg-secondary}",
  "$collectionName": "1. Color modes"
}
```

**Multi-mode tokens:** The `1. Color modes` collection has two modes (`Light mode` and `Dark mode`). The same variable path appears under each mode with different values/references.

### Reference resolution algorithm

```
function resolve(value, collectionName, allCollections):
  if value does not start with "{":
    return value  // literal

  path = extract path from between { }
  targetCollection = find collection by collectionName
  targetNode = walk path segments through targetCollection's mode data

  if targetNode.$value starts with "{":
    return resolve(targetNode.$value, targetNode.$collectionName, allCollections)
  else:
    return targetNode.$value
```

Max reference depth in ONEMO: 3 (Semantic → Alias → Primitive → literal).

---

## 3. Transformation Rules

### 3.1 Naming Rules

See **11.5 Section 1** for the complete 8-step transformation from Figma path to CSS custom property name. Summary:

1. Strip collection prefix (`_Primitives::`, `_Alias::`)
2. Replace `/` with `-`
3. Lowercase everything
4. Collapse spaces to single hyphen
5. Remove parenthetical annotations — `(900)`, `(light mode)`, `(0px)` → removed
6. Replace Unicode characters — One Dot Leader (U+2024) → hyphen (`0․5` → `0-5`)
7. Strip redundant category prefixes for semantic tokens
8. Prepend `--` and add layer prefix (`primitive-`, `alias-`, or Tailwind namespace)

### 3.2 Additional Rules (not in 11.5)

**Font style to font-weight mapping:**

| Figma Style Name | CSS font-weight | CSS font-style |
|---|---|---|
| Extra Light / ExtraLight | 200 | normal |
| Light | 300 | normal |
| Regular | 400 | normal |
| Medium | 500 | normal |
| SemiBold | 600 | normal |
| Bold | 700 | normal |
| ExtraBold | 800 | normal |
| Black | 900 | normal |
| Regular Italic | 400 | italic |
| Medium Italic | 500 | italic |
| Semi Bold Italic | 600 | italic |
| Bold Italic (named "XL" in Figma) | 700 | italic |

**Letter spacing values:**
Figma stores letter spacing as a scaled integer where the token name is 10x the actual percentage value. The primitive value IS the percentage:
- Primitive `+10` has value `1` → Figma means `1%`
- Primitive `-4` has value `-0.4` → Figma means `-0.4%`

**CRITICAL: CSS `letter-spacing` in `%` does NOT work in Chrome until v145 (not yet stable as of Feb 2026, per MDN compat-data #28979). The pipeline MUST convert to `em`.**

Conversion formula: `em_value = figma_value / 100`
- `1%` → `0.01em`
- `-1%` → `-0.01em`
- `0.4%` → `0.004em`
- `0%` → `0em`

**px to rem conversion:**
- Typography (font-size, line-height): `px / 16` → rem
- Spacing: `px / 16` → rem
- Dimensions: `px / 16` → rem
- Radius: Keep as `px` (small absolute values, rem scaling rarely desired)
- Widths/breakpoints: Keep as `px` (viewport-relative values)

**Paragraph spacing:** NOT a CSS property. Excluded from CSS output entirely. Component styles handle paragraph margins separately.

**Underscore state separators:** Figma uses `_` for state variants (e.g., `bg-primary_hover`). Pipeline converts to hyphen: `bg-primary-hover`.

---

## 4. CSS Output File Structure

All generated files go in `src/app/tokens/`. Each file starts with a header comment:
```css
/* Auto-generated by build-tokens.mjs from Figma Variables Export
   Source: onemo-ssot-global/11-design-system/11.7-figma-variables-baseline-feb16.json
   DO NOT EDIT — regenerate with: node scripts/build-tokens.mjs */
```

### 4.1 primitives.css — Layer 1

Contains ALL `_Primitives` collection values in a single `:root` block. These are raw, unaliased values. They MUST NOT be in `@theme` — primitives do not generate Tailwind utilities.

```css
:root {
  /* ═══ Colors: Base (5) ═══ */
  --primitive-color-base-white: #ffffff;
  --primitive-color-base-black: #000000;
  --primitive-color-base-transparent: rgba(255, 255, 255, 0);
  --primitive-color-base-onemo-white: #fafafa;
  --primitive-color-base-brand-black: #071013;

  /* ═══ Colors: Neutral — Gray (light mode) (12) ═══ */
  --primitive-color-gray-light-25: #fdfdfd;
  --primitive-color-gray-light-50: #fafafa;
  /* ... through 950 ... */

  /* ═══ Colors: Neutral — Gray (dark mode) (12) ═══ */
  --primitive-color-gray-dark-25: #fafafa;
  --primitive-color-gray-dark-50: #f7f7f7;
  /* ... through 950 ... */

  /* ═══ Colors: Neutral — Gray (dark mode alpha) (12) ═══ */
  --primitive-color-gray-dark-alpha-25: rgba(255, 255, 255, 0.98);
  /* ... through 950 ... */

  /* ═══ Colors: Dusty Palette — Blue Green (12) ═══ */
  --primitive-color-blue-green-25: #f2fcfa;
  --primitive-color-blue-green-50: #e3f9f4;
  /* ... through 950 ... */

  /* ... remaining 6 Dusty palette families ... */

  /* ═══ Dimensions (32) ═══ */
  --primitive-dimension-0: 0px;
  --primitive-dimension-0-5: 0.125rem;
  --primitive-dimension-1: 0.25rem;
  --primitive-dimension-1-5: 0.375rem;
  --primitive-dimension-2: 0.5rem;
  --primitive-dimension-3: 0.75rem;
  --primitive-dimension-4: 1rem;
  /* ... through 480 ... */

  /* ═══ Typography: Type Scale (24) ═══ */
  --primitive-type-scale-8: 0.5rem;
  --primitive-type-scale-10: 0.625rem;
  --primitive-type-scale-12: 0.75rem;
  --primitive-type-scale-14: 0.875rem;
  --primitive-type-scale-16: 1rem;
  --primitive-type-scale-18: 1.125rem;
  --primitive-type-scale-20: 1.25rem;
  --primitive-type-scale-22: 1.375rem;
  --primitive-type-scale-24: 1.5rem;
  --primitive-type-scale-26: 1.625rem;
  --primitive-type-scale-28: 1.75rem;
  --primitive-type-scale-32: 2rem;
  --primitive-type-scale-36: 2.25rem;
  --primitive-type-scale-40: 2.5rem;
  --primitive-type-scale-44: 2.75rem;
  --primitive-type-scale-48: 3rem;
  --primitive-type-scale-56: 3.5rem;
  --primitive-type-scale-64: 4rem;
  --primitive-type-scale-72: 4.5rem;
  --primitive-type-scale-80: 5rem;
  --primitive-type-scale-88: 5.5rem;
  --primitive-type-scale-96: 6rem;
  --primitive-type-scale-128: 8rem;
  --primitive-type-scale-360: 22.5rem;

  /* ═══ Typography: Letter Spacing (31) — converted from Figma % to em ═══ */
  --primitive-letter-spacing-neg-100: -0.1em;
  --primitive-letter-spacing-neg-80: -0.08em;
  /* ... */
  --primitive-letter-spacing-neg-10: -0.01em;
  --primitive-letter-spacing-neg-8: -0.008em;
  --primitive-letter-spacing-neg-4: -0.004em;
  --primitive-letter-spacing-0: 0em;
  --primitive-letter-spacing-pos-4: 0.004em;
  --primitive-letter-spacing-pos-8: 0.008em;
  --primitive-letter-spacing-pos-10: 0.01em;
  /* ... through +100 ... */

  /* ═══ Typography: Font Families (28) ═══ */
  --primitive-font-satoshi: "Satoshi", sans-serif;
  --primitive-font-oxanium: "Oxanium", sans-serif;
  --primitive-font-chillax: "Chillax", sans-serif;
  --primitive-font-nippo: "Nippo", sans-serif;
  --primitive-font-jetbrains-mono: "JetBrains Mono", monospace;
  --primitive-font-electric-blue: "Electric Blue", sans-serif;
  /* ... remaining 22 decorative fonts ... */
}
```

**Total: 252 variables.**

### 4.2 aliases.css — Layer 2

Contains ALL `_Alias` collection values in a single `:root` block. References primitives via `var()`. MUST NOT be in `@theme`.

```css
:root {
  /* ═══ Typography: Font Families (4) ═══ */
  --alias-font-primary: var(--primitive-font-satoshi);
  --alias-font-display-plain: var(--primitive-font-chillax);
  --alias-font-display-deco: var(--primitive-font-electric-blue);
  --alias-font-label: var(--primitive-font-oxanium);

  /* ═══ Typography: Font Styles (12) — direct values ═══ */
  --alias-font-style-extra-light: 200;
  --alias-font-style-light: 300;
  --alias-font-style-regular: 400;
  --alias-font-style-medium: 500;
  --alias-font-style-semibold: 600;
  --alias-font-style-bold: 700;
  --alias-font-style-extrabold: 800;
  --alias-font-style-black: 900;
  --alias-font-style-italic: 400;          /* + font-style: italic */
  --alias-font-style-medium-italic: 500;   /* + font-style: italic */
  --alias-font-style-semibold-italic: 600; /* + font-style: italic */
  --alias-font-style-bold-italic: 700;     /* + font-style: italic */

  /* ═══ Typography: Font Sizes (14) ═══ */
  --alias-font-size-display-2xl: var(--primitive-type-scale-72);
  --alias-font-size-display-xl: var(--primitive-type-scale-64);
  --alias-font-size-display-l: var(--primitive-type-scale-56);
  --alias-font-size-display-m: var(--primitive-type-scale-48);
  --alias-font-size-display-s: var(--primitive-type-scale-40);
  --alias-font-size-title-xl: var(--primitive-type-scale-36);
  --alias-font-size-title-l: var(--primitive-type-scale-32);
  --alias-font-size-title-m: var(--primitive-type-scale-24);
  --alias-font-size-title-s: var(--primitive-type-scale-20);
  --alias-font-size-text-xl: var(--primitive-type-scale-18);
  --alias-font-size-text-l: var(--primitive-type-scale-16);
  --alias-font-size-text-m: var(--primitive-type-scale-14);
  --alias-font-size-text-s: var(--primitive-type-scale-12);
  --alias-font-size-text-xs: var(--primitive-type-scale-10);

  /* ═══ Typography: Line Heights (14) ═══ */
  --alias-line-height-display-2xl: var(--primitive-type-scale-80);
  --alias-line-height-display-xl: var(--primitive-type-scale-72);
  --alias-line-height-display-l: var(--primitive-type-scale-64);
  --alias-line-height-display-m: var(--primitive-type-scale-56);
  --alias-line-height-display-s: var(--primitive-type-scale-48);
  --alias-line-height-title-xl: var(--primitive-type-scale-44);
  --alias-line-height-title-l: var(--primitive-type-scale-40);
  --alias-line-height-title-m: var(--primitive-type-scale-32);
  --alias-line-height-title-s: var(--primitive-type-scale-28);
  --alias-line-height-text-xl: var(--primitive-type-scale-26);
  --alias-line-height-text-l: var(--primitive-type-scale-24);
  --alias-line-height-text-m: var(--primitive-type-scale-22);
  --alias-line-height-text-s: var(--primitive-type-scale-18);
  --alias-line-height-text-xs: var(--primitive-type-scale-16);

  /* ═══ Typography: Letter Spacing (13) ═══ */
  --alias-letter-spacing-pos-10: var(--primitive-letter-spacing-pos-10);
  --alias-letter-spacing-pos-8: var(--primitive-letter-spacing-pos-8);
  --alias-letter-spacing-pos-6: var(--primitive-letter-spacing-pos-6);
  --alias-letter-spacing-pos-4: var(--primitive-letter-spacing-pos-4);
  --alias-letter-spacing-pos-2: var(--primitive-letter-spacing-pos-2);
  --alias-letter-spacing-pos-1: var(--primitive-letter-spacing-pos-1);
  --alias-letter-spacing-0: var(--primitive-letter-spacing-0);
  --alias-letter-spacing-neg-1: var(--primitive-letter-spacing-neg-1);
  --alias-letter-spacing-neg-2: var(--primitive-letter-spacing-neg-2);
  --alias-letter-spacing-neg-4: var(--primitive-letter-spacing-neg-4);
  --alias-letter-spacing-neg-6: var(--primitive-letter-spacing-neg-6);
  --alias-letter-spacing-neg-8: var(--primitive-letter-spacing-neg-8);
  --alias-letter-spacing-neg-10: var(--primitive-letter-spacing-neg-10);

  /* ═══ Typography: Paragraph Spacing (4) — NOT output to CSS ═══ */
  /* PaS-16 = 16px, PaS-12 = 12px, PaS-8 = 8px, PaS-0 = 0px */
  /* Paragraph spacing is handled by component margins, not custom properties */

  /* ═══ Colors: Brand (12 stops) ═══ */
  --alias-brand-25: var(--primitive-color-blue-green-25);
  --alias-brand-50: var(--primitive-color-blue-green-50);
  --alias-brand-100: var(--primitive-color-blue-green-100);
  --alias-brand-200: var(--primitive-color-blue-green-200);
  --alias-brand-300: var(--primitive-color-blue-green-300);
  --alias-brand-400: var(--primitive-color-blue-green-400);
  --alias-brand-500: var(--primitive-color-blue-green-500);
  --alias-brand-600: var(--primitive-color-blue-green-600);
  --alias-brand-700: var(--primitive-color-blue-green-700);
  --alias-brand-800: var(--primitive-color-blue-green-800);
  --alias-brand-900: var(--primitive-color-blue-green-900);
  --alias-brand-950: var(--primitive-color-blue-green-950);

  /* ═══ Colors: Error (12), Warning (12), Info (12), Success (12) ═══ */
  --alias-error-25: var(--primitive-color-tomato-jam-25);
  --alias-error-50: var(--primitive-color-tomato-jam-50);
  /* ... full scale for each system color ... */
  --alias-warning-25: var(--primitive-color-golden-glow-25);
  /* ... */
  --alias-info-25: var(--primitive-color-persian-blue-25);
  /* ... */
  --alias-success-25: var(--primitive-color-jade-green-25);
  /* ... */
}
```

**Total: 121 variables (117 output to CSS, 4 paragraph-spacing excluded).**

### 4.3 semantic.css — Layer 3 (mode-independent)

Contains tokens that are the SAME in light and dark mode. These go in `@theme` (not `inline`) and generate Tailwind utilities.

```css
@theme {
  /* ═══ Font Families (4) ═══ */
  /* Generates: font-primary, font-display-plain, font-display-deco, font-label */
  --font-primary: var(--alias-font-primary);
  --font-display-plain: var(--alias-font-display-plain);
  --font-display-deco: var(--alias-font-display-deco);
  --font-label: var(--alias-font-label);

  /* ═══ Spacing (17) ═══ */
  /* Generates: p-none, m-none, gap-none, p-xxs, m-xxs, etc. */
  --spacing-none: 0px;
  --spacing-xxs: 0.125rem;    /* 2px */
  --spacing-xs: 0.25rem;      /* 4px */
  --spacing-sm: 0.375rem;     /* 6px */
  --spacing-md: 0.5rem;       /* 8px */
  --spacing-lg: 0.75rem;      /* 12px */
  --spacing-xl: 1rem;         /* 16px */
  --spacing-2xl: 1.25rem;     /* 20px */
  --spacing-3xl: 1.5rem;      /* 24px */
  --spacing-4xl: 2rem;        /* 32px */
  --spacing-5xl: 2.5rem;      /* 40px */
  --spacing-6xl: 3rem;        /* 48px */
  --spacing-7xl: 4rem;        /* 64px */
  --spacing-8xl: 5rem;        /* 80px */
  --spacing-9xl: 6rem;        /* 96px */
  --spacing-10xl: 8rem;       /* 128px */
  --spacing-11xl: 10rem;      /* 160px */

  /* ═══ Radius (11) ═══ */
  /* Generates: rounded-none, rounded-xxs, etc. */
  --radius-none: 0px;
  --radius-xxs: 2px;
  --radius-xs: 4px;
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 10px;
  --radius-xl: 12px;
  --radius-2xl: 16px;
  --radius-3xl: 20px;
  --radius-4xl: 24px;
  --radius-full: 9999px;

  /* ═══ Widths (12) — under --spacing-* namespace ═══ */
  /* Generates: w-width-xxs, max-w-(--spacing-width-xxs), etc. */
  --spacing-width-xxs: 320px;     /* 320px */
  --spacing-width-xs: 384px;      /* 384px */
  --spacing-width-sm: 480px;      /* 480px */
  --spacing-width-md: 560px;      /* 560px */
  --spacing-width-lg: 640px;      /* 640px */
  --spacing-width-xl: 768px;      /* 768px */
  --spacing-width-2xl: 1024px;    /* 1,024px */
  --spacing-width-3xl: 1280px;    /* 1,280px */
  --spacing-width-4xl: 1440px;    /* 1,440px */
  --spacing-width-5xl: 1600px;    /* 1,600px */
  --spacing-width-6xl: 1920px;    /* 1,920px */
  --spacing-paragraph-max-width: 720px;

  /* ═══ Containers (3) — under --spacing-* namespace ═══ */
  --spacing-container-padding-mobile: 1rem;    /* 16px */
  --spacing-container-padding-desktop: 2rem;   /* 32px */
  --spacing-container-max-width: 1280px;       /* 1,280px */

  /* ═══ Breakpoints (6) ═══ */
  /* Generates: sm:, md:, lg:, xl:, 2xl:, 3xl: responsive variants */
  --breakpoint-sm: 480px;
  --breakpoint-md: 640px;
  --breakpoint-lg: 768px;
  --breakpoint-xl: 1024px;
  --breakpoint-2xl: 1280px;
  --breakpoint-3xl: 1440px;

  /* ═══ Typography Composites ═══ */
  /* See Section 7 for how these are assembled from Figma properties */

  /* --- Display / Brand Deco (Electric Blue) --- */
  --text-display-brand-deco-2xl: 4.5rem;
  --text-display-brand-deco-2xl--line-height: 5rem;
  --text-display-brand-deco-2xl--letter-spacing: 0.01em;
  --text-display-brand-deco-2xl--font-weight: 400;

  --text-display-brand-deco-xl: 4rem;
  --text-display-brand-deco-xl--line-height: 4.5rem;
  --text-display-brand-deco-xl--letter-spacing: 0.01em;
  --text-display-brand-deco-xl--font-weight: 500;

  --text-display-brand-deco-l: 3.5rem;
  --text-display-brand-deco-l--line-height: 4rem;
  --text-display-brand-deco-l--letter-spacing: 0.01em;
  --text-display-brand-deco-l--font-weight: 500;

  --text-display-brand-deco-m: 3rem;
  --text-display-brand-deco-m--line-height: 3.5rem;
  --text-display-brand-deco-m--letter-spacing: 0.01em;
  --text-display-brand-deco-m--font-weight: 600;

  --text-display-brand-deco-s: 2.5rem;
  --text-display-brand-deco-s--line-height: 3rem;
  --text-display-brand-deco-s--letter-spacing: 0.01em;
  --text-display-brand-deco-s--font-weight: 600;

  /* --- Display / Brand Plain (Chillax) --- */
  --text-display-brand-plain-2xl: 4.5rem;
  --text-display-brand-plain-2xl--line-height: 5rem;
  --text-display-brand-plain-2xl--letter-spacing: -0.01em;
  --text-display-brand-plain-2xl--font-weight: 500;

  --text-display-brand-plain-xl: 4rem;
  --text-display-brand-plain-xl--line-height: 4.5rem;
  --text-display-brand-plain-xl--letter-spacing: -0.008em;
  --text-display-brand-plain-xl--font-weight: 500;

  --text-display-brand-plain-l: 3.5rem;
  --text-display-brand-plain-l--line-height: 4rem;
  --text-display-brand-plain-l--letter-spacing: -0.004em;
  --text-display-brand-plain-l--font-weight: 500;

  --text-display-brand-plain-m: 3rem;
  --text-display-brand-plain-m--line-height: 3.5rem;
  --text-display-brand-plain-m--letter-spacing: 0em;
  --text-display-brand-plain-m--font-weight: 500;

  --text-display-brand-plain-s: 2.5rem;
  --text-display-brand-plain-s--line-height: 3rem;
  --text-display-brand-plain-s--letter-spacing: 0em;
  --text-display-brand-plain-s--font-weight: 500;

  /* --- Title / Screen (Satoshi) --- */
  --text-title-screen-primary: 2.25rem;
  --text-title-screen-primary--line-height: 2.75rem;
  --text-title-screen-primary--letter-spacing: 0em;
  --text-title-screen-primary--font-weight: 700;

  --text-title-screen-secondary: 2rem;
  --text-title-screen-secondary--line-height: 2.5rem;
  --text-title-screen-secondary--letter-spacing: 0em;
  --text-title-screen-secondary--font-weight: 500;

  /* --- Title / Section (Satoshi) --- */
  --text-title-section-primary: 1.5rem;
  --text-title-section-primary--line-height: 2rem;
  --text-title-section-primary--letter-spacing: 0em;
  --text-title-section-primary--font-weight: 700;

  --text-title-section-secondary: 1.25rem;
  --text-title-section-secondary--line-height: 1.75rem;
  --text-title-section-secondary--letter-spacing: 0em;
  --text-title-section-secondary--font-weight: 500;

  /* --- Title / Product (Satoshi) — 1:1 line-height ratio --- */
  --text-title-product-primary: 1rem;
  --text-title-product-primary--line-height: 1rem;
  --text-title-product-primary--letter-spacing: 0em;
  --text-title-product-primary--font-weight: 500;

  --text-title-product-secondary: 0.875rem;
  --text-title-product-secondary--line-height: 0.875rem;
  --text-title-product-secondary--letter-spacing: 0em;
  --text-title-product-secondary--font-weight: 400;

  /* --- Title / Headline (Satoshi) — 1:1 line-height ratio --- */
  --text-title-headline: 1rem;
  --text-title-headline--line-height: 1rem;
  --text-title-headline--letter-spacing: 0em;
  --text-title-headline--font-weight: 500;

  /* --- Body (Satoshi) --- */
  --text-body-heading: 1.5rem;
  --text-body-heading--line-height: 2rem;
  --text-body-heading--letter-spacing: 0em;
  --text-body-heading--font-weight: 500;

  --text-body-normal: 1rem;
  --text-body-normal--line-height: 1.5rem;
  --text-body-normal--letter-spacing: 0em;
  --text-body-normal--font-weight: 400;

  --text-body-strong: 1rem;
  --text-body-strong--line-height: 1.5rem;
  --text-body-strong--letter-spacing: 0em;
  --text-body-strong--font-weight: 500;

  --text-body-caption: 0.875rem;
  --text-body-caption--line-height: 1.375rem;
  --text-body-caption--letter-spacing: 0em;
  --text-body-caption--font-weight: 400;

  /* --- Label (Oxanium) — all have 1:1 line-height ratio --- */
  --text-label-xl: 1.25rem;
  --text-label-xl--line-height: 1.25rem;
  --text-label-xl--letter-spacing: 0em;
  --text-label-xl--font-weight: 500;

  --text-label-l: 1rem;
  --text-label-l--line-height: 1rem;
  --text-label-l--letter-spacing: 0em;
  --text-label-l--font-weight: 500;

  --text-label-m: 0.875rem;
  --text-label-m--line-height: 0.875rem;
  --text-label-m--letter-spacing: 0.002em;
  --text-label-m--font-weight: 400;

  --text-label-s: 0.75rem;
  --text-label-s--line-height: 0.75rem;
  --text-label-s--letter-spacing: 0.004em;
  --text-label-s--font-weight: 400;

  --text-label-xs: 0.625rem;
  --text-label-xs--line-height: 0.625rem;
  --text-label-xs--letter-spacing: 0.004em;
  --text-label-xs--font-weight: 400;
}
```

### 4.4 semantic-inline.css — Layer 3 (mode-dependent)

The most complex file. Three sections:
1. `:root` — light mode defaults (semantic intermediary variables)
2. `[data-theme="dark"]` — dark mode overrides
3. `@theme inline` — registers for Tailwind utility generation

```css
/* ═══ Section 1: Light mode defaults ═══ */
:root {
  /* --- Text (23 tokens) --- */
  --semantic-text-primary: var(--primitive-color-gray-light-900);
  --semantic-text-primary-on-brand: var(--primitive-color-base-white);
  --semantic-text-secondary: var(--primitive-color-gray-light-700);
  --semantic-text-secondary-hover: var(--primitive-color-gray-light-800);
  --semantic-text-secondary-on-brand: var(--alias-brand-200);
  --semantic-text-tertiary: var(--primitive-color-gray-light-600);
  --semantic-text-tertiary-hover: var(--primitive-color-gray-light-700);
  --semantic-text-tertiary-on-brand: var(--alias-brand-200);
  --semantic-text-quaternary: var(--primitive-color-gray-light-500);
  --semantic-text-quaternary-on-brand: var(--alias-brand-300);
  --semantic-text-white: var(--primitive-color-base-white);
  --semantic-text-disabled: var(--primitive-color-gray-light-500);
  --semantic-text-placeholder: var(--primitive-color-gray-light-500);
  --semantic-text-placeholder-subtle: var(--primitive-color-gray-light-300);
  --semantic-text-brand-primary: var(--alias-brand-900);
  --semantic-text-brand-secondary: var(--alias-brand-700);
  --semantic-text-brand-secondary-hover: var(--alias-brand-800);
  --semantic-text-brand-tertiary: var(--alias-brand-600);
  --semantic-text-brand-tertiary-alt: var(--alias-brand-600);
  --semantic-text-error-primary: var(--alias-error-600);
  --semantic-text-error-primary-hover: var(--alias-error-700);
  --semantic-text-warning-primary: var(--alias-warning-600);
  --semantic-text-success-primary: var(--alias-success-600);

  /* --- Foreground (21 tokens) --- */
  --semantic-fg-primary: var(--primitive-color-gray-light-900);
  --semantic-fg-secondary: var(--primitive-color-gray-light-700);
  --semantic-fg-secondary-hover: var(--primitive-color-gray-light-800);
  --semantic-fg-tertiary: var(--primitive-color-gray-light-600);
  --semantic-fg-tertiary-hover: var(--primitive-color-gray-light-700);
  --semantic-fg-quaternary: var(--primitive-color-gray-light-400);
  --semantic-fg-quaternary-hover: var(--primitive-color-gray-light-500);
  --semantic-fg-white: var(--primitive-color-base-white);
  --semantic-fg-disabled: var(--primitive-color-gray-light-400);
  --semantic-fg-disabled-subtle: var(--primitive-color-gray-light-300);
  --semantic-fg-brand-primary: var(--alias-brand-600);
  --semantic-fg-brand-primary-alt: var(--alias-brand-600);
  --semantic-fg-brand-secondary: var(--alias-brand-500);
  --semantic-fg-brand-secondary-alt: var(--alias-brand-500);
  --semantic-fg-brand-secondary-hover: var(--alias-brand-600);
  --semantic-fg-error-primary: var(--alias-error-600);
  --semantic-fg-error-secondary: var(--alias-error-500);
  --semantic-fg-warning-primary: var(--alias-warning-600);
  --semantic-fg-warning-secondary: var(--alias-warning-500);
  --semantic-fg-success-primary: var(--alias-success-600);
  --semantic-fg-success-secondary: var(--alias-success-500);

  /* --- Background (20 tokens) --- */
  --semantic-bg-primary: var(--primitive-color-base-white);
  --semantic-bg-primary-hover: var(--primitive-color-gray-light-50);
  --semantic-bg-primary-alt: var(--primitive-color-base-white);
  --semantic-bg-secondary: var(--primitive-color-gray-light-50);
  --semantic-bg-secondary-hover: var(--primitive-color-gray-light-100);
  --semantic-bg-secondary-alt: var(--primitive-color-gray-light-100);
  --semantic-bg-secondary-subtle: var(--primitive-color-gray-light-25);
  --semantic-bg-tertiary: var(--primitive-color-gray-light-100);
  --semantic-bg-quaternary: var(--primitive-color-gray-light-200);
  --semantic-bg-active: var(--primitive-color-gray-light-50);
  --semantic-bg-disabled: var(--primitive-color-gray-light-100);
  --semantic-bg-disabled-subtle: var(--primitive-color-gray-light-50);
  --semantic-bg-overlay: rgba(0, 0, 0, 0.5);
  --semantic-bg-brand-primary: var(--alias-brand-50);
  --semantic-bg-brand-primary-alt: var(--alias-brand-50);
  --semantic-bg-brand-secondary: var(--alias-brand-100);
  --semantic-bg-brand-solid: var(--alias-brand-600);
  --semantic-bg-brand-solid-hover: var(--alias-brand-700);
  --semantic-bg-brand-section: var(--alias-brand-800);
  --semantic-bg-brand-section-subtle: var(--alias-brand-700);
  /* ... error, warning, success bg tokens ... */

  /* --- Border (10 tokens) --- */
  --semantic-border-primary: var(--primitive-color-gray-light-300);
  --semantic-border-secondary: var(--primitive-color-gray-light-200);
  --semantic-border-secondary-alt: rgba(0, 0, 0, 0.08);
  --semantic-border-tertiary: var(--primitive-color-gray-light-100);
  --semantic-border-disabled: var(--primitive-color-gray-light-300);
  --semantic-border-disabled-subtle: var(--primitive-color-gray-light-200);
  --semantic-border-brand: var(--alias-brand-500);
  --semantic-border-brand-alt: var(--alias-brand-600);
  --semantic-border-error: var(--alias-error-500);
  --semantic-border-error-subtle: var(--alias-error-300);

  /* --- Effects: Focus rings, Shadows (19 tokens) --- */
  --semantic-focus-ring: var(--alias-brand-500);
  --semantic-focus-ring-error: var(--alias-error-500);
  --semantic-shadow-xs: rgba(10, 13, 18, 0.05);
  /* ... remaining shadow tokens ... */

  /* --- Component colors: Alpha, Utility, Components (52 tokens) --- */
  --semantic-alpha-white-10: rgba(255, 255, 255, 0.1);
  /* ... all alpha, utility-gray, button, footer, icon, slider, toggle tokens ... */
}

/* ═══ Section 2: Dark mode overrides ═══ */
[data-theme="dark"] {
  /* --- Text --- */
  --semantic-text-primary: var(--primitive-color-gray-dark-50);
  --semantic-text-primary-on-brand: var(--primitive-color-gray-dark-50);
  --semantic-text-secondary: var(--primitive-color-gray-dark-300);
  --semantic-text-secondary-hover: var(--primitive-color-gray-dark-200);
  /* ... all dark overrides for every token that differs ... */

  /* --- Background --- */
  --semantic-bg-primary: var(--primitive-color-gray-dark-950);
  --semantic-bg-primary-hover: var(--primitive-color-gray-dark-900);
  /* ... */

  /* --- Alpha (semantics invert) --- */
  --semantic-alpha-white-10: rgba(12, 14, 18, 0.1);
  --semantic-alpha-black-10: rgba(255, 255, 255, 0.1);
  /* ... */
}

/* ═══ Section 3: Register for Tailwind utilities ═══ */
@theme inline {
  /* Every semantic color token, mapped to Tailwind --color-* namespace */
  --color-text-primary: var(--semantic-text-primary);
  --color-text-primary-on-brand: var(--semantic-text-primary-on-brand);
  --color-text-secondary: var(--semantic-text-secondary);
  /* ... all text tokens ... */

  --color-fg-primary: var(--semantic-fg-primary);
  /* ... all fg tokens ... */

  --color-bg-primary: var(--semantic-bg-primary);
  --color-bg-primary-hover: var(--semantic-bg-primary-hover);
  /* ... all bg tokens ... */

  --color-border-primary: var(--semantic-border-primary);
  /* ... all border tokens ... */

  --color-focus-ring: var(--semantic-focus-ring);
  --color-shadow-xs: var(--semantic-shadow-xs);
  /* ... all effect tokens ... */

  --color-alpha-white-10: var(--semantic-alpha-white-10);
  /* ... all alpha, utility, component tokens ... */
}
```

**Total: 157 unique semantic color tokens × 3 sections (light default + dark override + theme registration).**

---

## 5. Tailwind v4 Integration

### 5.1 Import Order

```css
/* src/app/globals.css */
@import "tailwindcss";

/* Token layers — order matters: primitives first, then aliases, then semantic */
@import "./tokens/primitives.css";
@import "./tokens/aliases.css";
@import "./tokens/semantic.css";
@import "./tokens/semantic-inline.css";
```

`@import "tailwindcss"` MUST come first. It establishes the Tailwind layer structure. Token CSS files are imported after and their `@theme`/`@theme inline` blocks are merged into Tailwind's theme.

### 5.2 @theme vs @theme inline

| Directive | Use When | Example |
|---|---|---|
| `@theme` | Value is static (literal or will be resolved at build time) | `--spacing-xl: 1rem;` |
| `@theme inline` | Value references a CSS variable that changes at runtime | `--color-bg-primary: var(--semantic-bg-primary);` |

Mode-dependent color tokens MUST use `@theme inline` because their values change when `[data-theme="dark"]` is applied. Without `inline`, Tailwind would bake in the light-mode resolved value at build time and dark mode would not work.

Mode-independent tokens (spacing, radius, typography) use `@theme` because their `var()` references always resolve to the same value regardless of theme.

### 5.3 Utility Class Name Mapping

| CSS Custom Property | Generated Utility | Usage Example |
|---|---|---|
| `--color-bg-primary` | `bg-bg-primary` | `<div class="bg-bg-primary">` |
| `--color-text-primary` | `text-text-primary` | `<p class="text-text-primary">` |
| `--color-border-primary` | `border-border-primary` | `<div class="border border-border-primary">` |
| `--color-focus-ring` | `ring-focus-ring` | `<input class="ring-focus-ring">` |
| `--font-primary` | `font-primary` | `<p class="font-primary">` |
| `--font-display-deco` | `font-display-deco` | `<h1 class="font-display-deco">` |
| `--spacing-xl` | `p-xl`, `m-xl`, `gap-xl`, `w-xl`, `h-xl` | `<div class="p-xl gap-xl">` |
| `--radius-md` | `rounded-md` | `<div class="rounded-md">` |
| `--text-display-brand-deco-2xl` | `text-display-brand-deco-2xl` | `<h1 class="text-display-brand-deco-2xl">` |
| `--breakpoint-sm` | `sm:` responsive variant | `<div class="sm:p-xl">` |

### 5.4 Typography Utility Composition

Font family and text preset are separate utilities. Combine them:

```html
<!-- Display heading — Electric Blue decorative font -->
<h1 class="font-display-deco text-display-brand-deco-2xl">
  Hero Headline
</h1>

<!-- Body text — Satoshi primary font -->
<p class="font-primary text-body-normal">
  Regular paragraph text
</p>

<!-- Label — Oxanium font -->
<span class="font-label text-label-m uppercase">
  Badge Text
</span>
```

The `text-*` utility applies font-size, line-height, letter-spacing, and font-weight in one class. The `font-*` utility applies font-family separately.

### 5.5 Dark Mode

ONEMO uses `[data-theme="dark"]` on `<html>`, NOT Tailwind's `dark:` variant. Colors swap automatically through the CSS variable cascade:

1. `:root` sets `--semantic-*` vars to light mode values
2. `[data-theme="dark"]` overrides `--semantic-*` vars to dark mode values
3. `@theme inline` registers `--color-*` pointing to `--semantic-*`
4. Tailwind utilities reference `--color-*` which resolves through the cascade

No `dark:` prefix needed on any component class. One `data-theme` attribute swap changes everything.

```tsx
// Toggle theme:
document.documentElement.setAttribute('data-theme', 'dark');
// or remove for light:
document.documentElement.removeAttribute('data-theme');
```

---

## 6. Shopify Liquid Integration

### 6.1 Current Theme Pattern

The existing ONEMO Shopify theme (`onemo-theme`) uses this pattern in `snippets/css-variables.liquid`:

```liquid
{% style %}
  {{ settings.type_primary_font | font_face: font_display: 'swap' }}

  :root {
    --font-primary--family: {{ settings.type_primary_font.family }}, {{ settings.type_primary_font.fallback_families }};
    --color-background: {{ settings.background_color }};
    --color-foreground: {{ settings.foreground_color }};
  }
{% endstyle %}
```

The pipeline extends this pattern — same approach, more variables.

### 6.2 Settings Schema Structure

Token types map to Shopify setting types:

```json
{
  "name": "Design Tokens — Colors",
  "settings": [
    {
      "type": "color",
      "id": "color_bg_primary",
      "default": "#ffffff",
      "label": "Background Primary"
    },
    {
      "type": "color",
      "id": "color_text_primary",
      "default": "#181d27",
      "label": "Text Primary"
    }
  ]
}
```

| Token Type | Shopify Setting Type | Default Value |
|---|---|---|
| Color | `color` | Hex value (resolved from Figma, light mode) |
| Font family | `font_picker` | Shopify font ID (e.g., `work_sans_n4`) |
| Spacing | `range` | Pixel value (min/max/step) |
| Radius | `range` | Pixel value |

### 6.3 Font Handling — Self-Hosted Custom Fonts

ONEMO uses custom fonts (Satoshi, Chillax, Electric Blue, Oxanium) that are NOT in Shopify's font library. Two approaches:

**Approach A: Self-host fonts (recommended for custom fonts)**
```liquid
{%- comment -%} Self-hosted custom fonts {%- endcomment -%}
<style>
  @font-face {
    font-family: "Satoshi";
    src: url("{{ 'Satoshi-Variable.woff2' | asset_url }}") format("woff2");
    font-weight: 200 900;
    font-display: swap;
  }
  @font-face {
    font-family: "Electric Blue";
    src: url("{{ 'ElectricBlue-Regular.woff2' | asset_url }}") format("woff2");
    font-weight: 400;
    font-display: swap;
  }
</style>
```

Font files go in `onemo-theme/assets/`. Reference via `asset_url` filter.

**Approach B: Use font_picker with override**
Keep `font_picker` for the Shopify admin UX (merchants can see a font preview), but override with self-hosted font in CSS. The `font_picker` selection serves as metadata only.

**Decision: Approach A for custom fonts.** The `font_picker` setting type is still used for the Primary font slot (Satoshi can be swapped to a Shopify-library font by merchants). Display and Label fonts are self-hosted with no `font_picker`.

### 6.4 Color Format

`{{ settings.color_bg_primary }}` outputs the hex value WITH `#` prefix (e.g., `#ffffff`). Can be used directly in CSS:

```liquid
:root {
  --color-bg-primary: {{ settings.color_bg_primary }};
  --color-text-primary: {{ settings.color_text_primary }};
}
```

No `var()` chains in Liquid output — the Shopify theme uses resolved hex values directly. The three-layer alias chain exists only in the Next.js pipeline.

### 6.5 Dark Mode in Shopify

Shopify Horizon themes use `color_scheme_group` for light/dark scheme management. ONEMO uses `[data-theme="dark"]` which is NOT compatible with Shopify's built-in scheme system.

For the Shopify theme, dark mode requires either:
1. **Duplicate settings**: `color_bg_primary_dark`, `color_text_primary_dark`, etc. — manually toggled by a theme toggle script
2. **A single "Dark mode" toggle setting**: that uses a `.dark` class to switch CSS variables

This is a constraint — see Section 9.

---

## 7. Typography Composite Assembly

### 7.1 Figma Structure

Each text preset in Figma has 6 properties:

```
6. Typography / Display / Brand Deco / 2XL / Font     → font family
6. Typography / Display / Brand Deco / 2XL / Style    → font weight/style
6. Typography / Display / Brand Deco / 2XL / Size     → font-size (px)
6. Typography / Display / Brand Deco / 2XL / Line     → line-height (px)
6. Typography / Display / Brand Deco / 2XL / Letter   → letter-spacing (%)
6. Typography / Display / Brand Deco / 2XL / Paragraph → paragraph-spacing (excluded)
```

### 7.2 Assembly Algorithm

For each preset group `{Category}/{Variant}/{Size}`:

1. **Font** property → determines font slot (lookup in the font-family alias mapping)
   - References `{Typography.Font-Family.Primary}` → `--font-primary`
   - References `{Typography.Font-Family.Secondary - Deco}` → `--font-display-deco`
   - This becomes the `font-*` class to pair with, NOT a CSS sub-property

2. **Size** property → `--text-{preset-name}: {value in rem}`
   - Follow alias chain to primitive Type Scale value → convert px to rem

3. **Line** property → `--text-{preset-name}--line-height: {value in rem}`
   - Follow alias chain to primitive Type Scale value → convert px to rem

4. **Letter** property → `--text-{preset-name}--letter-spacing: {value}em`
   - Follow alias chain to primitive Letter Spacing value → convert `%` to `em` (see Section 3.2)

5. **Style** property → `--text-{preset-name}--font-weight: {numeric weight}`
   - Map style name to numeric weight (see Section 3.2 table)

6. **Paragraph** property → SKIP (not a CSS property)

### 7.3 Preset Name Construction

```
Figma path:  Display / Brand Deco / 2XL
CSS name:    display-brand-deco-2xl
Full prop:   --text-display-brand-deco-2xl

Figma path:  Title / Screen / Primary
CSS name:    title-screen-primary
Full prop:   --text-title-screen-primary

Figma path:  Body / Normal
CSS name:    body-normal
Full prop:   --text-body-normal

Figma path:  Label / M
CSS name:    label-m
Full prop:   --text-label-m
```

### 7.4 Complete Preset Table

All 26 presets resolved from the Feb 16 Figma JSON. Letter-spacing converted from Figma `%` to `em` (see Section 3.2).

| # | Preset | font-size | line-height | letter-spacing | font-weight | Font Slot |
|---|--------|-----------|-------------|----------------|-------------|-----------|
| 1 | `display-brand-deco-2xl` | 4.5rem | 5rem | 0.01em | 400 | `--font-display-deco` |
| 2 | `display-brand-deco-xl` | 4rem | 4.5rem | 0.01em | 500 | `--font-display-deco` |
| 3 | `display-brand-deco-l` | 3.5rem | 4rem | 0.01em | 500 | `--font-display-deco` |
| 4 | `display-brand-deco-m` | 3rem | 3.5rem | 0.01em | 600 | `--font-display-deco` |
| 5 | `display-brand-deco-s` | 2.5rem | 3rem | 0.01em | 600 | `--font-display-deco` |
| 6 | `display-brand-plain-2xl` | 4.5rem | 5rem | -0.01em | 500 | `--font-display-plain` |
| 7 | `display-brand-plain-xl` | 4rem | 4.5rem | -0.008em | 500 | `--font-display-plain` |
| 8 | `display-brand-plain-l` | 3.5rem | 4rem | -0.004em | 500 | `--font-display-plain` |
| 9 | `display-brand-plain-m` | 3rem | 3.5rem | 0em | 500 | `--font-display-plain` |
| 10 | `display-brand-plain-s` | 2.5rem | 3rem | 0em | 500 | `--font-display-plain` |
| 11 | `title-screen-primary` | 2.25rem | 2.75rem | 0em | 700 | `--font-primary` |
| 12 | `title-screen-secondary` | 2rem | 2.5rem | 0em | 500 | `--font-primary` |
| 13 | `title-section-primary` | 1.5rem | 2rem | 0em | 700 | `--font-primary` |
| 14 | `title-section-secondary` | 1.25rem | 1.75rem | 0em | 500 | `--font-primary` |
| 15 | `title-product-primary` | 1rem | 1rem ★ | 0em | 500 | `--font-primary` |
| 16 | `title-product-secondary` | 0.875rem | 0.875rem ★ | 0em | 400 | `--font-primary` |
| 17 | `title-headline` | 1rem | 1rem ★ | 0em | 500 | `--font-primary` |
| 18 | `body-heading` | 1.5rem | 2rem | 0em | 500 | `--font-primary` |
| 19 | `body-normal` | 1rem | 1.5rem | 0em | 400 | `--font-primary` |
| 20 | `body-strong` | 1rem | 1.5rem | 0em | 500 | `--font-primary` |
| 21 | `body-caption` | 0.875rem | 1.375rem | 0em | 400 | `--font-primary` |
| 22 | `label-xl` | 1.25rem | 1.25rem ★ | 0em | 500 | `--font-label` |
| 23 | `label-l` | 1rem | 1rem ★ | 0em | 500 | `--font-label` |
| 24 | `label-m` | 0.875rem | 0.875rem ★ | 0.002em | 400 | `--font-label` |
| 25 | `label-s` | 0.75rem | 0.75rem ★ | 0.004em | 400 | `--font-label` |
| 26 | `label-xs` | 0.625rem | 0.625rem ★ | 0.004em | 400 | `--font-label` |

**★ = 1:1 line-height ratio** — the Figma `Line` property references `Font-Size` aliases (not `Line-Height` aliases), producing `line-height = font-size`. Intentional for compact UI elements (product cards, labels, headlines).

**Design patterns:**
- **Brand Deco** — weight increases as size decreases (Regular → Medium → SemiBold). Letter-spacing consistently +1% (loose tracking for decorative display).
- **Brand Plain** — consistent Medium (500). Letter-spacing tightens at larger sizes (-1% at 72px down to 0 at ≤48px).
- **Title/Screen, Title/Section** — Bold for Primary, Medium for Secondary. No tracking adjustment.
- **Title/Product, Title/Headline** — 1:1 line-height for compact card layouts. No tracking.
- **Body** — Regular (400) for Normal/Caption, Medium (500) for Heading/Strong. Standard line-height ratios.
- **Label** — Medium at large sizes, Regular at smaller. Letter-spacing increases at smaller sizes (+0.2% at M, +0.4% at S/XS) for readability.

---

## 8. Dark Mode Implementation

### 8.1 The Three-Step Pattern

**Step 1: Semantic intermediary variables in `:root` (light mode defaults)**
```css
:root {
  --semantic-bg-primary: var(--primitive-color-base-white);
  --semantic-text-primary: var(--primitive-color-gray-light-900);
}
```

**Step 2: Dark mode overrides**
```css
[data-theme="dark"] {
  --semantic-bg-primary: var(--primitive-color-gray-dark-950);
  --semantic-text-primary: var(--primitive-color-gray-dark-50);
}
```

**Step 3: Register for Tailwind**
```css
@theme inline {
  --color-bg-primary: var(--semantic-bg-primary);
  --color-text-primary: var(--semantic-text-primary);
}
```

### 8.2 Why This Pattern

- `:root` and `[data-theme="dark"]` swap the **intermediary** variables
- `@theme inline` always points to the same intermediary — Tailwind sees stable references
- Components use one class (`bg-bg-primary`) that works in both modes
- The `inline` keyword tells Tailwind to resolve `var()` at runtime instead of baking in the build-time value

### 8.3 Theme Selector

`[data-theme="dark"]` on `<html>`. Applied via JavaScript:

```tsx
// src/app/layout.tsx
export default function RootLayout({ children }) {
  return (
    <html lang="en" data-theme="light">
      <body>{children}</body>
    </html>
  );
}
```

Toggle via client-side script or React state. The selector avoids conflict with Tailwind's `dark:` variant and Shopify's `prefers-color-scheme`.

### 8.4 Self-Referencing Tokens in Dark Mode

Some dark mode tokens reference other tokens within the same `1. Color modes` collection (marked `[self]` in 11.6). These resolve to sibling semantic variables:

```css
/* Light mode — bg-brand-section references alias directly */
--semantic-bg-brand-section: var(--alias-brand-800);

/* Dark mode — bg-brand-section references bg-secondary (sibling token) */
[data-theme="dark"] {
  --semantic-bg-brand-section: var(--semantic-bg-secondary);
}
```

The build script must detect self-references and output `var(--semantic-*)` instead of `var(--alias-*)` or `var(--primitive-*)`.

---

## 9. Constraints and Limitations

### 9.1 Cross-Platform Gaps

| Constraint | Next.js Impact | Shopify Impact | Resolution |
|---|---|---|---|
| **Custom fonts not in Shopify library** | None (self-hosted) | Cannot use `font_picker` for Electric Blue, Chillax, Oxanium | Self-host `.woff2` in theme assets |
| **Typography composites** | Full support via `--text-*` namespace | No equivalent — must apply individual properties | Theme CSS uses separate font-size, line-height, etc. |
| **Dark mode** | `[data-theme="dark"]` + CSS cascade | Shopify has no native dark mode mechanism | Theme implements own toggle + duplicate color settings |
| **Alpha/rgba colors** | Full support in CSS | `{{ settings.color }}` outputs hex only, no alpha | Alpha tokens stored as raw rgba in theme CSS, not in settings |
| **Shadow composites** | Component-level assembly from color tokens | Same pattern | Shadow colors are tokens; box-shadow composition is per-component |
| **Variable cascade** | Full `var()` chain (primitive → alias → semantic) | No cascade — Liquid outputs resolved hex values | Theme CSS is flat; alias swapping requires regeneration |

### 9.2 Tokens That Don't Cross to Liquid

These tokens exist in the Next.js CSS pipeline but have no Shopify `settings_schema.json` equivalent:

- **All primitives** — raw values, never exposed to theme merchants
- **All aliases** — brand mapping layer, internal to the pipeline
- **Shadow color tokens** — rgba values, stored as CSS literals
- **Alpha overlay tokens** — rgba values, stored as CSS literals
- **Component-specific tokens** (button icons, toggle borders, etc.) — too granular for merchant settings
- **Typography composites** — Shopify doesn't have a "text preset" setting type

### 9.3 Tokens That Cross to Both Platforms

| Category | Count | Shopify Setting Type |
|---|---|---|
| Semantic colors (text, bg, border, fg) | ~40 most important | `color` |
| Font families (4 slots) | 4 | `font_picker` (Primary) or self-hosted |
| Spacing scale | 17 | `range` (selected subset only) |
| Radius scale | 11 | `range` (selected subset only) |

---

## 10. Build Script Specification

### 10.1 Location and Usage

```bash
# Location: onemo-next/scripts/build-tokens.mjs
# Usage:
node scripts/build-tokens.mjs [path-to-json]

# Default: reads ../onemo-ssot-global/11-design-system/11.7-figma-variables-baseline-feb16.json
# Output: src/app/tokens/*.css
```

### 10.2 Script Architecture

```
build-tokens.mjs
│
├── parseCollections(json)         → Map<collectionName, collectionData>
├── resolveReference(value, collection, allCollections) → resolvedValue
├── transformName(figmaPath, layer) → cssPropertyName
├── routeToLayer(collectionName)   → "primitive" | "alias" | "semantic" | "semantic-inline"
├── assembleTypography(typographyVars) → Map<presetName, compositeProperties>
├── generatePrimitivesCSS(primitives) → string
├── generateAliasesCSS(aliases) → string
├── generateSemanticCSS(semanticTokens, typographyComposites) → string
├── generateSemanticInlineCSS(colorModeTokens, lightMode, darkMode) → string
└── main()
    ├── Read JSON
    ├── Parse collections
    ├── Resolve all references
    ├── Route tokens to layers
    ├── Assemble typography composites
    ├── Generate 4 CSS files
    └── Print summary (token counts per file)
```

### 10.3 Verification After Running

After running the script, verify:

1. **Token counts match:**
   - `primitives.css`: 252 variables
   - `aliases.css`: ~117 variables (121 minus 4 paragraph-spacing)
   - `semantic.css`: ~200 variables (spacing + radius + widths + containers + breakpoints + typography composites)
   - `semantic-inline.css`: 157 unique color tokens (×3 for light/dark/theme registration)

2. **Spot-check 10 tokens** against 11.6 analysis values
3. **CSS parses clean:** No syntax errors
4. **Dev server runs:** `npm run dev` with the imports added to `globals.css`
5. **Utility classes generate:** Check that `bg-bg-primary`, `p-xl`, `rounded-md`, `font-primary`, `text-display-brand-deco-2xl` appear in the Tailwind output

---

## 11. Documentation Basis

### References Used

| Source | Version | Verified | Reference File |
|---|---|---|---|
| Tailwind CSS v4 | v4.1.18 | 2026-02-16 | `13-references/tailwind-v4.md` |
| Shopify Horizon theme | v3.3.1 | 2026-02-16 | `13-references/shopify-liquid-horizon.md` |
| DTCG Design Tokens Format | 2025.10 | 2026-02-16 | `13-references/css-design-tokens.md` |
| Figma Variables Export | Feb 16, 2026 | 2026-02-16 | `11.7-figma-variables-baseline-feb16.json` |
| ONEMO naming convention | — | 2026-02-16 | `11.5-naming-convention.md` |
| ONEMO export analysis | — | 2026-02-16 | `11.6-figma-export-analysis-feb16.md` |

### Decision Dependencies

| Decision | Source | Status |
|---|---|---|
| Token scope (what ships to code) | ONE-181 | Pending — currently shipping all tokens |
| Naming convention | ONE-178 / 11.5 | Done |
| Color format (hex) | Session decision 2026-02-16 | Done |
| Dark mode selector | 11.5 Section 5.4 | Done |
| Sync process/cadence | ONE-180 | Pending |
